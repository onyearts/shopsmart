{% extends 'shop/base.html' %}
{% load widget_tweaks %}
{% load static %}

{% block content %}

<div class="card">
  <div class="card-body">
    <h4 class="card-title">Edit Profile</h4>
    <p class="card-description"> Update your basic information </p>

    <form id="edit-profile-form" method="POST" enctype="multipart/form-data" class="forms-sample">
      {% csrf_token %}

      <div class="form-group">
        <label for="first_name">First Name</label>
        {{ user_form.first_name|add_class:"form-control" }}
      </div>

      <div class="form-group">
        <label for="last_name">Last Name</label>
        {{ user_form.last_name|add_class:"form-control" }}
      </div>

      <div class="form-group">
        <label for="profile_picture">Profile Picture</label><br>
        {{ user_form.profile_picture|add_class:"form-control" }}
      </div>

      {% if is_shop_owner %}
        <div class="form-group">
          <label for="shop_name">Shop Name</label>
          {{ profile_form.shop_name|add_class:"form-control" }}
        </div>

        <div class="form-group">
          <label for="phone">Phone</label>
          {{ profile_form.phone|add_class:"form-control" }}
        </div>

        <div class="form-group">
          <label for="address">Address</label>
          {{ profile_form.address|add_class:"form-control" }}
        </div>

        <div class="form-group">
          <label for="postal_code">Postal Code</label>
          {{ profile_form.postal_code|add_class:"form-control" }}
        </div>

        <div class="form-group">
          <label for="city">City</label>
          {{ profile_form.city|add_class:"form-control" }}
        </div>

        <div class="form-group">
          <label for="map_address">Map Address</label>
          {{ profile_form.map_address|add_class:"form-control" }}
        </div>


        <!-- Map untouched -->
        <div class="form-group">
          <label>Pick Your Shop Location</label>
          <div id="map-container" class="rounded shadow-sm mb-3" style="width: 100%; height: 500px; overflow: hidden;">
            <div id="map" style="width: 100%; height: 100%;"></div>
          </div>
        </div>

        <input type="hidden" id="latitude" name="latitude" value="{{ profile_form.latitude.value }}">
        <input type="hidden" id="longitude" name="longitude" value="{{ profile_form.longitude.value }}">
      {% else %}
        <div class="form-group">
          <label for="phone">Phone</label>
          {{ profile_form.phone|add_class:"form-control" }}
        </div>

        <div class="form-group">
          <label for="preferred_location">Preferred Location</label>
          {{ profile_form.preferred_location|add_class:"form-control" }}
        </div>
      {% endif %}

      <button type="submit" class="btn btn-primary me-2">Save Changes</button>
      <a href="{% url 'shops:profile' %}" class="btn btn-dark">Cancel</a>
    </form>
  </div>
</div>


{% if is_shop_owner %}
<!-- Leaflet JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Ghana boundaries
    const southWest = L.latLng(4.7, -3.3), // SW corner of Ghana
          northEast = L.latLng(11.2, 1.3); // NE corner of Ghana
    const bounds = L.latLngBounds(southWest, northEast);

    const map = L.map('map', {
        center: [7.9465, -1.0232],  // Ghana center
        zoom: 7,
        maxBounds: bounds, // Restrict to Ghana
        maxBoundsViscosity: 1.0, // Strict bounds
        minZoom: 7,
        maxZoom: 19 // Allow detailed zoom
    });

    // High-detail OSM tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);

    map.setMaxBounds(bounds);

    let marker;

    // Function to update marker on the map
    function setMarker(lat, lng) {
        document.getElementById('latitude').value = lat;
        document.getElementById('longitude').value = lng;

        if (marker) {
            marker.setLatLng([lat, lng]);
        } else {
            marker = L.marker([lat, lng]).addTo(map);
        }
        map.setView([lat, lng], 16);
    }

    // When user clicks on map
    map.on('click', async function(e) {
        if (!bounds.contains(e.latlng)) {
            showToast("Please select a location within Ghana", "warning");
            return;
        }

        const { lat, lng } = e.latlng;
        setMarker(lat, lng);

        // Reverse geocode using Nominatim
        try {
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`);
            const data = await res.json();
            const address = data.display_name || '';
            const addressInput = document.getElementById("id_map_address");
            if (addressInput) addressInput.value = address;
        } catch (error) {
            console.error("Failed to fetch address", error);
        }
    });

    // Auto-geocode when postal code or address changes
    const addressField = document.getElementById('id_address');
    const postalCodeField = document.getElementById('id_postal_code');
    const cityField = document.getElementById('id_city');

    async function geocodeAddress() {
        const address = addressField ? addressField.value.trim() : '';
        const postal = postalCodeField ? postalCodeField.value.trim() : '';
        const city = cityField ? cityField.value.trim() : '';

        if (!address && !postal && !city) return;

        const query = `${address}, ${postal}, ${city}, Ghana`;
        try {
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
            const data = await res.json();
            if (data && data.length > 0) {
                const { lat, lon } = data[0];
                setMarker(lat, lon);
            } else {
                showToast("Address not found. Please check details.", "warning");
            }
        } catch (error) {
            console.error("Geocoding error:", error);
        }
    }

    [addressField, postalCodeField, cityField].forEach(field => {
        if (field) field.addEventListener('blur', geocodeAddress);
    });

    // Preload marker if coordinates exist
    const lat = parseFloat(document.getElementById('latitude').value);
    const lng = parseFloat(document.getElementById('longitude').value);
    if (!isNaN(lat) && !isNaN(lng)) {
        if (bounds.contains([lat, lng])) {
            setMarker(lat, lng);
        }
    }
});
</script>

{% endif %}


<div id="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
document.getElementById('edit-profile-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const form = e.target;
    const formData = new FormData(form);

    try {
        const response = await axios.post("", formData, {
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'multipart/form-data'
            }
        });

        if (response.status === 200) {
            showToast("Profile updated successfully! Redirecting...", "success");
            // Redirect to profile page after 3 seconds
            setTimeout(() => {
                window.location.href = "{% url 'shops:profile' %}";
            }, 3000);
        }
    } catch (error) {
        console.error(error);
        if (error.response && error.response.data.errors) {
            showToast("Error: " + Object.values(error.response.data.errors)[0][0].message, "danger");
        } else {
            showToast("Failed to update profile. Please check your inputs.", "danger");
        }
    }
});

// Toast function
function showToast(message, type = "success") {
    const container = document.getElementById("toast-container");
    const toast = document.createElement("div");
    toast.className = `toast align-items-center text-bg-${type} border-0 show mb-2`;
    toast.setAttribute("role", "alert");
    toast.style.transition = "opacity 0.5s ease-in-out";
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.parentElement.parentElement.remove()"></button>
        </div>`;
    container.appendChild(toast);

    // Auto-remove after 4 seconds
    setTimeout(() => {
        toast.style.opacity = "0";
        setTimeout(() => toast.remove(), 500);
    }, 4000);
}
</script>



{% endblock %}
