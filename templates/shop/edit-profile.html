{% extends 'shop/base.html' %}
{% load widget_tweaks %}
{% load static %}

{% block content %}
<div class="page-container">
    <div class="page-content">
        <div class="row">
            <div class="col-12">
                <!-- Page Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h3 class="page-title mb-1">
                            <i class="ri-user-settings-line me-2"></i> Edit Profile
                        </h3>
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb mb-0">
                                <li class="breadcrumb-item"><a href="{% url 'shops:dashboard' %}">Dashboard</a></li>
                                <li class="breadcrumb-item"><a href="{% url 'shops:profile' %}">Profile</a></li>
                                <li class="breadcrumb-item active" aria-current="page">Edit</li>
                            </ol>
                        </nav>
                    </div>
                </div>

                <!-- Edit Profile Card -->
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h4 class="card-title">
                            <i class="ri-edit-box-line me-2"></i> Update Your Information
                        </h4>
                        <p class="card-description text-muted mb-4">
                            Keep your profile details current and accurate
                        </p>

                        <form id="edit-profile-form" method="POST" enctype="multipart/form-data" class="forms-sample">
                            {% csrf_token %}
                            
                            <div class="row g-3">
                                <!-- Personal Info Section -->
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="ri-user-3-line me-1"></i> First Name
                                        </label>
                                        {{ user_form.first_name|add_class:"form-control" }}
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="ri-user-3-line me-1"></i> Last Name
                                        </label>
                                        {{ user_form.last_name|add_class:"form-control" }}
                                    </div>
                                </div>
                                
                                <div class="col-12">
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="ri-image-line me-1"></i> Profile Picture
                                        </label>
                                        {{ user_form.profile_picture|add_class:"form-control" }}
                                    </div>
                                </div>
                                
                                <!-- Shop Owner Specific Fields -->
                                {% if is_shop_owner %}
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="ri-store-2-line me-1"></i> Shop Name
                                        </label>
                                        {{ profile_form.shop_name|add_class:"form-control" }}
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="ri-phone-line me-1"></i> Phone
                                        </label>
                                        {{ profile_form.phone|add_class:"form-control" }}
                                    </div>
                                </div>
                                
                                <div class="col-12">
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="ri-map-pin-line me-1"></i> Address
                                        </label>
                                        {{ profile_form.address|add_class:"form-control" }}
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="ri-mail-line me-1"></i> Postal Code
                                        </label>
                                        {{ profile_form.postal_code|add_class:"form-control" }}
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="ri-building-line me-1"></i> City
                                        </label>
                                        {{ profile_form.city|add_class:"form-control" }}
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="ri-map-2-line me-1"></i> Map Address (Auto-filled)
                                        </label>
                                        {{ profile_form.map_address|add_class:"form-control"|attr:"readonly:readonly" }}
                                    </div>
                                </div>
                                
                                <!-- Map Section -->
                                <div class="col-12">
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="ri-map-pin-2-line me-1"></i> Click on map to set shop location
                                        </label>
                                        <div id="map-container" class="rounded shadow-sm mb-3" style="width: 100%; height: 400px; overflow: hidden;">
                                            <div id="map" style="width: 100%; height: 100%;"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <input type="hidden" id="latitude" name="latitude" value="{{ profile_form.latitude.value }}">
                                <input type="hidden" id="longitude" name="longitude" value="{{ profile_form.longitude.value }}">
                                
                                {% else %}
                                <!-- Customer Specific Fields -->
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="ri-phone-line me-1"></i> Phone
                                        </label>
                                        {{ profile_form.phone|add_class:"form-control" }}
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="ri-map-pin-user-line me-1"></i> Preferred Location
                                        </label>
                                        {{ profile_form.preferred_location|add_class:"form-control" }}
                                    </div>
                                </div>
                                {% endif %}
                                
                                <!-- Form Actions -->
                                <div class="col-12 mt-4">
                                    <button type="submit" id="save-btn" class="btn btn-primary me-2">
                                        <span id="save-text">
                                            <i class="ri-save-line me-1"></i> Save Changes
                                        </span>
                                        <span id="save-loader" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                    </button>
                                    <a href="{% url 'shops:profile' %}" class="btn btn-outline-secondary">
                                        <i class="ri-close-line me-1"></i> Cancel
                                    </a>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div id="toast-container" class="position-fixed top-0 end-0 p-3" style="z-index: 9999;"></div>

{% if is_shop_owner %}
<!-- Leaflet JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Ghana boundaries
    const southWest = L.latLng(4.7, -3.3), // SW corner of Ghana
          northEast = L.latLng(11.2, 1.3); // NE corner of Ghana
    const bounds = L.latLngBounds(southWest, northEast);

    const map = L.map('map', {
        center: [7.9465, -1.0232],  // Ghana center
        zoom: 7,
        maxBounds: bounds, // Restrict to Ghana
        maxBoundsViscosity: 1.0, // Strict bounds
        minZoom: 7,
        maxZoom: 19 // Allow detailed zoom
    });

    // High-detail OSM tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);

    map.setMaxBounds(bounds);

    let marker;
    const mapAddressField = document.getElementById('id_map_address');

    // Function to update marker on the map
    function setMarker(lat, lng) {
        document.getElementById('latitude').value = lat;
        document.getElementById('longitude').value = lng;

        if (marker) {
            marker.setLatLng([lat, lng]);
        } else {
            marker = L.marker([lat, lng]).addTo(map);
        }
        map.setView([lat, lng], 16);
    }

    // When user clicks on map
    map.on('click', async function(e) {
        if (!bounds.contains(e.latlng)) {
            showToast("Please select a location within Ghana", "warning");
            return;
        }

        const { lat, lng } = e.latlng;
        setMarker(lat, lng);

        // Show loading state for address lookup
        mapAddressField.value = "Loading address...";
        
        try {
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`);
            const data = await res.json();
            const address = data.display_name || 'Address not found';
            mapAddressField.value = address;
        } catch (error) {
            console.error("Failed to fetch address", error);
            mapAddressField.value = "Could not retrieve address";
        }
    });

    // Preload marker if coordinates exist
    const lat = parseFloat(document.getElementById('latitude').value);
    const lng = parseFloat(document.getElementById('longitude').value);
    if (!isNaN(lat) && !isNaN(lng)) {
        if (bounds.contains([lat, lng])) {
            setMarker(lat, lng);
            // Load address if coordinates exist but field is empty
            if (mapAddressField && !mapAddressField.value) {
                map.on('click', {latlng: L.latLng(lat, lng)});
            }
        }
    }
});
</script>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
document.getElementById('edit-profile-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const form = e.target;
    const formData = new FormData(form);
    const saveBtn = document.getElementById('save-btn');
    const saveText = document.getElementById('save-text');
    const saveLoader = document.getElementById('save-loader');

    // Show loader
    saveBtn.disabled = true;
    saveLoader.classList.remove('d-none');
    saveText.innerHTML = '<i class="ri-loader-4-line me-1"></i> Saving...';

    try {
        const response = await axios.post("", formData, {
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'multipart/form-data'
            }
        });

        if (response.status === 200) {
            showToast("Profile updated successfully! Redirecting...", "success");
            // Redirect to profile page after 3 seconds
            setTimeout(() => {
                window.location.href = "{% url 'shops:profile' %}";
            }, 3000);
        }
    } catch (error) {
        console.error(error);
        if (error.response && error.response.data.errors) {
            showToast("Error: " + Object.values(error.response.data.errors)[0][0].message, "danger");
        } else {
            showToast("Failed to update profile. Please check your inputs.", "danger");
        }
    } finally {
        // Hide loader
        saveBtn.disabled = false;
        saveLoader.classList.add('d-none');
        saveText.innerHTML = '<i class="ri-save-line me-1"></i> Save Changes';
    }
});

// Toast function
function showToast(message, type = "success") {
    const container = document.getElementById("toast-container");
    const toast = document.createElement("div");
    toast.className = `toast align-items-center text-bg-${type} border-0 show mb-2`;
    toast.setAttribute("role", "alert");
    toast.style.transition = "opacity 0.5s ease-in-out";
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.parentElement.parentElement.remove()"></button>
        </div>
        <div class="toast-progress bg-white opacity-25" style="height: 3px; animation: shrink 4s linear forwards;"></div>
    `;
    container.appendChild(toast);

    // Auto-remove after 4 seconds
    setTimeout(() => {
        toast.style.opacity = "0";
        setTimeout(() => toast.remove(), 500);
    }, 4000);
}
</script>

<style>
    /* Meteor-inspired styling */
    .form-control, .form-select {
        border-radius: 0.5rem;
        padding: 0.5rem 1rem;
        border: 1px solid #e0e0e0;
    }
    
    .form-control[readonly] {
        background-color: #f8f9fa;
    }
    
    .form-label {
        font-weight: 500;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
    }
    
    .card {
        border-radius: 0.75rem;
        overflow: hidden;
    }
    
    #map-container {
        border-radius: 0.75rem;
    }
    
    @keyframes shrink {
        from { width: 100%; }
        to { width: 0%; }
    }
    
    .toast {
        border-radius: 0.75rem;
        overflow: hidden;
    }
    
    #save-btn {
        min-width: 120px;
    }
    
    .spinner-border {
        vertical-align: middle;
    }
</style>

{% endblock %}