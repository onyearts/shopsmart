{% extends 'customers/base.html' %}
{% block content %}
<div class="page-container">
    <div class="page-content">
        <!-- Enhanced Search Bar -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex align-items-center justify-content-between">
                        <h4 class="card-title mb-0">Shop items from stores nearby</h4>
                    </div>
                    <div class="card-body position-relative">
                        <form method="GET" action="{% url 'customers:product_list' %}" id="search-form">
                            <div class="input-group">
                                <input type="text" 
                                    class="form-control search-input" 
                                    name="q" 
                                    id="search-input"
                                    placeholder="Type here to search (e.g. 'rice', 'milk')" 
                                    aria-label="Search"
                                    value="{{ request.GET.q }}"
                                    autocomplete="off">
                                <button class="btn btn-primary" type="submit">
                                    <i class="ri-search-line"></i>
                                </button>
                            </div>
                        </form>
                        <!-- Suggestions dropdown -->
                        <div class="search-suggestions dropdown-menu w-100 shadow" id="search-suggestions"></div>
                        <!-- Did you mean? container -->
                        <div class="did-you-mean mt-2 d-none" id="did-you-mean"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Product Grid -->
        <div class="row">
            {% for product in products %}
            <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
                <div class="card product-card h-100">
                    <!-- Product Image -->
                    <div class="position-relative product-image-container">
                        <a href="{% url 'customers:product_detail' product.id %}">
                            <img src="{{ product.image.url }}" class="card-img-top" alt="{{ product.name }}">
                        </a>
                        {% if user.is_authenticated %}
                        <button class="btn btn-sm position-absolute top-0 end-0 m-2 p-0 bg-transparent border-0 add-wishlist" data-product-id="{{ product.id }}">
                            <i class="{% if product.id in wishlist_product_ids %}ri-heart-fill{% else %}ri-heart-line{% endif %} fs-18" style="color: {% if product.id in wishlist_product_ids %}red{% else %}white{% endif %}; text-shadow: 0 0 3px rgba(0,0,0,0.5)"></i>
                        </button>
                        {% endif %}
                    </div>
                    
                    <!-- Product Info -->
                    <div class="card-body">
                        <h5 class="card-title mb-1">{{ product.name|truncatechars:30 }}</h5>
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <span class="text-primary fw-bold">GHâ‚µ {{ product.price|floatformat:2 }}</span>
                            <span class="text-muted small"><i class="ri-map-pin-line me-1"></i> 0.5 mile away</span>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center py-4">
                        <i class="ri-information-line fs-32 text-info mb-3"></i>
                        <h4>No products available</h4>
                        <p class="mb-0">Check back later for new products</p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Pagination -->
        {% if page_obj.paginator.num_pages > 1 %}
        <div class="row">
            <div class="col-12">
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center mt-4">
                        {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}">
                                <i class="ri-arrow-left-s-line"></i>
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link"><i class="ri-arrow-left-s-line"></i></span>
                        </li>
                        {% endif %}
                        
                        {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                        <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                        {% else %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                        </li>
                        {% endif %}
                        {% endfor %}
                        
                        {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}">
                                <i class="ri-arrow-right-s-line"></i>
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link"><i class="ri-arrow-right-s-line"></i></span>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Toast Notification -->
<div id="toast-container" class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 11"></div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('search-input');
    const suggestionsContainer = document.getElementById('search-suggestions');
    const didYouMeanContainer = document.getElementById('did-you-mean');
    let debounceTimer;
    let lastSearchTerm = '';

    // Toast notification function
    function showToast(msg, type='success') {
        const toast = document.createElement('div');
        toast.className = `toast show align-items-center text-white bg-${type} border-0`;
        toast.role = 'alert';
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${msg}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        document.getElementById('toast-container').appendChild(toast);
        
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 200);
        }, 3000);
    }

    // Fetch search suggestions
    async function fetchSuggestions(query) {
        if (!query || query.length < 2) {
            suggestionsContainer.innerHTML = '';
            suggestionsContainer.classList.remove('show');
            return;
        }

        try {
            const response = await fetch(`{% url 'customers:search_suggestions' %}?q=${encodeURIComponent(query)}`);
            const data = await response.json();
            
            if (data.suggestions && data.suggestions.length > 0) {
                suggestionsContainer.innerHTML = data.suggestions.map(item => `
                    <a class="dropdown-item" href="{% url 'customers:product_list' %}?q=${encodeURIComponent(item)}">
                        <i class="ri-search-line me-2"></i>${item}
                    </a>
                `).join('');
                suggestionsContainer.classList.add('show');
            } else {
                suggestionsContainer.innerHTML = '<div class="dropdown-item text-muted">No suggestions found</div>';
                suggestionsContainer.classList.add('show');
            }
        } catch (error) {
            console.error('Error fetching suggestions:', error);
            suggestionsContainer.classList.remove('show');
        }
    }

    // Check for possible search corrections
    function checkSearchCorrection(searchTerm, products) {
        if (products.length === 0 && searchTerm.length > 2) {
            // In a real app, you'd call a backend endpoint for search corrections
            const commonProducts = ['rice', 'milk', 'bread', 'eggs', 'sugar'];
            const suggestions = commonProducts.filter(item => 
                item.toLowerCase().includes(searchTerm.toLowerCase()) ||
                getSimilarity(item, searchTerm) > 0.6
            );
            
            if (suggestions.length > 0) {
                didYouMeanContainer.innerHTML = `
                    <div class="alert alert-light">
                        Did you mean: ${suggestions.map(item => `
                            <a href="{% url 'customers:product_list' %}?q=${item}">${item}</a>
                        `).join(' or ')}?
                    </div>
                `;
                didYouMeanContainer.classList.remove('d-none');
            } else {
                didYouMeanContainer.classList.add('d-none');
            }
        } else {
            didYouMeanContainer.classList.add('d-none');
        }
    }

    // Simple similarity function (Levenshtein distance)
    function getSimilarity(s1, s2) {
        const longer = s1.length > s2.length ? s1 : s2;
        const shorter = s1.length > s2.length ? s2 : s1;
        const longerLength = longer.length;
        if (longerLength === 0) return 1.0;
        
        return (longerLength - editDistance(longer, shorter)) / parseFloat(longerLength);
    }

    function editDistance(s1, s2) {
        s1 = s1.toLowerCase();
        s2 = s2.toLowerCase();
        
        const costs = [];
        for (let i = 0; i <= s1.length; i++) {
            let lastValue = i;
            for (let j = 0; j <= s2.length; j++) {
                if (i === 0) {
                    costs[j] = j;
                } else {
                    if (j > 0) {
                        let newValue = costs[j - 1];
                        if (s1.charAt(i - 1) !== s2.charAt(j - 1)) {
                            newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                        }
                        costs[j - 1] = lastValue;
                        lastValue = newValue;
                    }
                }
            }
            if (i > 0) costs[s2.length] = lastValue;
        }
        return costs[s2.length];
    }

    // Search event listeners
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                fetchSuggestions(e.target.value);
            }, 300);
        });

        searchInput.addEventListener('focus', () => {
            if (searchInput.value.length >= 2) {
                fetchSuggestions(searchInput.value);
            }
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-input') && !e.target.closest('.search-suggestions')) {
                suggestionsContainer.classList.remove('show');
            }
        });
    }

    // Check for search corrections on page load
    {% if request.GET.q and not products %}
    checkSearchCorrection("{{ request.GET.q|escapejs }}", {{ products|length }});
    {% endif %}

    // Wishlist functionality
    document.querySelectorAll('.add-wishlist').forEach(btn => {
        btn.addEventListener('click', async function (e) {
            e.preventDefault();
            e.stopPropagation();
            
            const icon = this.querySelector('i');
            const pid = this.dataset.productId;

            try {
                const res = await fetch("{% url 'customers:add_wishlist' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: JSON.stringify({ product_id: pid }),
                });

                const data = await res.json();

                if (res.ok) {
                    showToast(data.message, 'success');
                    icon.classList.toggle('ri-heart-line');
                    icon.classList.toggle('ri-heart-fill');
                    icon.style.color = icon.classList.contains('ri-heart-fill') ? 'red' : 'white';
                } else {
                    throw new Error(data.error || 'Error updating wishlist');
                }
            } catch (err) {
                showToast(err.message, 'danger');
            }
        });
    });
});
</script>

<style>
    .product-card {
        transition: all 0.3s ease;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid #f0f0f0;
    }
    .product-card:hover {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
        transform: translateY(-3px);
    }
    .product-image-container {
        padding: 15px;
        text-align: center;
    }
    .product-image-container img {
        height: 180px;
        width: 100%;
        object-fit: cover;
        border-radius: 6px;
    }
    .card-title {
        font-size: 0.95rem;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .page-link {
        color: #495057;
    }
    .page-item.active .page-link {
        background-color: #4a6bff;
        border-color: #4a6bff;
    }


     .search-input {
        padding-right: 40px;
    }
    
    .search-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        z-index: 1000;
        display: none;
        max-height: 300px;
        overflow-y: auto;
    }
    
    .search-suggestions.show {
        display: block;
    }
    
    .search-suggestions a {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        padding: 8px 16px;
    }
    
    .search-suggestions a:hover {
        background-color: #f8f9fa;
    }
    
    .did-you-mean a {
        color: #4a6bff;
        text-decoration: underline;
        margin: 0 4px;
    }
    
    .search-highlight {
        background-color: #fff8e1;
        font-weight: 500;
    }
</style>
{% endblock %}