{% extends 'shop/base.html' %}
{% block content %}
<div class="page-container">
    <div class="page-content">
        <div class="row">
            <div class="col-12">
                <!-- Page Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h3 class="page-title mb-1">
                            <i class="ri-key-2-line me-2"></i> Change Password
                        </h3>
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb mb-0">
                                <li class="breadcrumb-item"><a href="{% url 'shops:dashboard' %}">Dashboard</a></li>
                                <li class="breadcrumb-item"><a href="{% url 'shops:profile' %}">Profile</a></li>
                                <li class="breadcrumb-item active" aria-current="page">Password</li>
                            </ol>
                        </nav>
                    </div>
                </div>

                <!-- Password Card -->
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <p class="text-muted mb-4">
                            <i class="ri-shield-keyhole-line me-2"></i> Update your account password securely
                        </p>

                        <form id="password-change-form" method="POST">
                            {% csrf_token %}
                            
                            <div class="row g-3">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        <label for="id_old_password" class="form-label">
                                            <i class="ri-lock-line me-2"></i>Current Password
                                        </label>
                                        <input type="password" name="old_password" class="form-control" 
                                               id="id_old_password" placeholder="Enter current password" required>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="id_new_password1" class="form-label">
                                            <i class="ri-key-line me-2"></i>New Password
                                        </label>
                                        <input type="password" name="new_password1" class="form-control" 
                                               id="id_new_password1" placeholder="Enter new password" required>
                                        <small class="text-muted">At least 8 characters with numbers and symbols</small>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="id_new_password2" class="form-label">
                                            <i class="ri-key-fill me-2"></i>Confirm Password
                                        </label>
                                        <input type="password" name="new_password2" class="form-control" 
                                               id="id_new_password2" placeholder="Confirm new password" required>
                                    </div>
                                </div>
                                
                                <div class="col-12 mt-3">
                                    <div class="d-flex justify-content-end gap-2">
                                        <a href="{% url 'shops:profile' %}" class="btn btn-light">
                                            <i class="ri-close-line me-1"></i> Cancel
                                        </a>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="ri-save-line me-1"></i> Change Password
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Meteor Toast Container -->
<div id="meteor-toast-container" class="position-fixed top-0 end-0 p-3" style="z-index: 9999"></div>

<!-- Axios -->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
document.getElementById('password-change-form').addEventListener('submit', async function (e) {
  e.preventDefault();

  const form = e.target;
  const formData = new FormData(form);
  const submitBtn = form.querySelector('button[type="submit"]');
  const originalBtnText = submitBtn.innerHTML;
  
  try {
    submitBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> Changing...`;
    submitBtn.disabled = true;
    
    const response = await axios.post("", formData, {
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': '{{ csrf_token }}',
      }
    });

    if (response.status === 200) {
      showMeteorToast("Password changed successfully!", "success");
      setTimeout(() => {
        window.location.href = "{% url 'shops:profile' %}";
      }, 2000);
    }
  } catch (error) {
    const msg = error.response?.data?.error || "Failed to change password. Please check your current password and try again.";
    showMeteorToast(msg, "danger");
  } finally {
    submitBtn.innerHTML = originalBtnText;
    submitBtn.disabled = false;
  }
});

function showMeteorToast(message, type = "success") {
  const container = document.getElementById("meteor-toast-container");
  const toast = document.createElement("div");
  toast.className = `meteor-toast toast show align-items-center text-bg-${type}`;
  toast.setAttribute("role", "alert");
  toast.setAttribute("aria-live", "assertive");
  toast.setAttribute("aria-atomic", "true");
  toast.innerHTML = `
    <div class="d-flex">
      <div class="toast-body">
        <i class="ri-${type === 'success' ? 'check-line' : 'close-line'} me-2"></i>
        ${message}
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>`;
  
  container.appendChild(toast);
  
  // Auto-remove toast after delay
  setTimeout(() => {
    toast.classList.add('fade');
    setTimeout(() => toast.remove(), 500);
  }, 5000);
  
  // Manual close handler
  toast.querySelector('.btn-close').addEventListener('click', () => {
    toast.classList.add('fade');
    setTimeout(() => toast.remove(), 500);
  });
}
</script>

<style>
    /* Meteor Toast Styling */
    .meteor-toast {
        border-radius: 0.75rem;
        border: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
    }
    
    /* Form Input Styling */
    .form-control {
        border-radius: 0.5rem;
        padding: 0.5rem 1rem;
    }
    
    /* Button Loading State */
    .btn .spinner-border {
        vertical-align: text-top;
    }
</style>
{% endblock %}