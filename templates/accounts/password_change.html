{% extends 'shop/base.html' %}
{% block content %}
<div class="container mt-5">
  <div class="card">
    <div class="card-body">
      <h4 class="card-title">Change Password</h4>
      <p class="card-description"> Update your account password securely </p>

      <form id="password-change-form" method="POST" class="forms-sample">
        {% csrf_token %}
        <div class="form-group">
          <label for="id_old_password">Current Password</label>
          <input type="password" name="old_password" class="form-control" id="id_old_password" placeholder="Enter current password" required>
        </div>

        <div class="form-group">
          <label for="id_new_password1">New Password</label>
          <input type="password" name="new_password1" class="form-control" id="id_new_password1" placeholder="Enter new password" required>
        </div>

        <div class="form-group">
          <label for="id_new_password2">Confirm New Password</label>
          <input type="password" name="new_password2" class="form-control" id="id_new_password2" placeholder="Confirm new password" required>
        </div>

        <button type="submit" class="btn btn-primary me-2">Change Password</button>
        <a href="{% url 'shops:profile' %}" class="btn btn-light">Cancel</a>
      </form>
    </div>
  </div>
</div>

<!-- Toast container -->
<div id="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>

<!-- Axios -->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
document.getElementById('password-change-form').addEventListener('submit', async function (e) {
  e.preventDefault();

  const form = e.target;
  const formData = new FormData(form);

  try {
    const response = await axios.post("", formData, {
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': '{{ csrf_token }}',
      }
    });

    if (response.status === 200) {
      showToast("Password changed successfully!", "success");
      setTimeout(() => {
        window.location.href = "{% url 'shops:profile' %}";
      }, 3000);
    }
  } catch (error) {
    const msg = error.response?.data?.error || "Failed to change password. Check the inputs.";
    showToast(msg, "danger");
  }
});

function showToast(message, type = "success") {
  const container = document.getElementById("toast-container");
  const toast = document.createElement("div");
  toast.className = `toast align-items-center text-bg-${type} border-0 show mb-2`;
  toast.setAttribute("role", "alert");
  toast.innerHTML = `
    <div class="d-flex">
      <div class="toast-body">${message}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.parentElement.parentElement.remove()"></button>
    </div>`;
  container.appendChild(toast);

  setTimeout(() => {
    toast.style.opacity = "0";
    setTimeout(() => toast.remove(), 500);
  }, 4000);
}
</script>
{% endblock %}
