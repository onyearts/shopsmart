{% extends "base.html" %}
{% load static %}

{% block title %}Register as Shop Owner - ShopSmart{% endblock %}

{% block content %}
<!-- Success Page (hidden by default) -->
<div id="success-page" class="container py-5" style="display: {% if request.GET.success %}block{% else %}none{% endif %};">
  <div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
      <div class="card shadow-lg border-0 rounded-4 p-4 p-md-5 text-center">
        <div class="mb-4">
          <img src="{% static 'images/success-icon.jpeg' %}" alt="Success" style="width: 100px; height: 100px;">
        </div>

        <h2 class="mb-3 fw-bold">Almost Done!</h2>
        <p class="lead mb-3">
          We've sent a 6-digit verification code to your email.
        </p>
        <p class="lead mb-4">
          Click below to verify your account and complete the registration process.
        </p>

        <div class="d-grid gap-2">
          <a href="{% url 'accounts:verify' %}?email={{ email }}" class="btn btn-primary btn-lg">
            <i class="bi bi-shield-check me-2"></i> Continue to Verification
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Registration Form (visible by default) -->
<div id="registration-form-page" class="container py-5">
  <div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
      <div class="card shadow-lg border-0 rounded-4 p-4 p-md-5">
       <form method="post" id="registration-form" novalidate>
            {% csrf_token %}

            <div id="error-container" class="container mb-4" style="display: none;">
                <div class="row justify-content-center">
                    <div class="col-md-8 col-lg-6">
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <strong>Error!</strong> <span id="error-message"></span>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    </div>
                </div>
            </div>

            <h2 class="mb-4 fw-bold text-center">Register as a Shop Owner</h2>
            <!-- Error container -->
            {% if error %}
                <div id="error-container" class="alert alert-danger mb-4">
                    {{ error }}
                </div>
            {% endif %}

            {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {{ form.non_field_errors }}
            </div>
            {% endif %}

            <div class="mb-3">
                {{ user_form.email.label_tag }}
                {{ user_form.email }}
                {% if user_form.email.errors %}
                <div class="invalid-feedback d-block">{{ user_form.email.errors.0 }}</div>
                {% endif %}
            </div>

            <div class="mb-3 row g-2">
                <div class="col-md-6 position-relative">
                    {{ user_form.password1.label_tag }}
                    <div class="input-group">
                        {{ user_form.password1 }}
                        <button type="button" class="btn btn-outline-secondary toggle-password" tabindex="-1">
                            <i class="bi bi-eye-slash"></i>
                        </button>
                    </div>
                    {% if user_form.password1.errors %}
                    <div class="invalid-feedback d-block">{{ user_form.password1.errors.0 }}</div>
                    {% endif %}
                </div>

                <div class="col-md-6 position-relative">
                    {{ user_form.password2.label_tag }}
                    <div class="input-group">
                        {{ user_form.password2 }}
                        <button type="button" class="btn btn-outline-secondary toggle-password" tabindex="-1">
                            <i class="bi bi-eye-slash"></i>
                        </button>
                    </div>
                    {% if user_form.password2.errors %}
                    <div class="invalid-feedback d-block">{{ user_form.password2.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>

            {% for field in profile_form %}
            <div class="mb-3">
                {{ field.label_tag }}
                {% if field.name == 'phone' %}
                <div class="input-group">
                    <span class="input-group-text">+233</span>
                    <input type="tel" name="{{ field.name }}" class="form-control" 
                           maxlength="9" pattern="[0-9]{9}" 
                           title="Enter 9 digits after +233" required
                           value="{{ field.value|default:''|slice:'4:' }}"
                           placeholder="241234567"
                           id="id_phone">
                </div>
                <small class="form-text text-muted">Enter your 9-digit Ghanaian number without the leading 0 (e.g., 241234567)</small>
                <div id="phone-error" class="invalid-feedback" style="display: none;"></div>
                {% else %}
                {{ field }}
                {% endif %}
                {% if field.errors %}
                <div class="invalid-feedback d-block">{{ field.errors.0 }}</div>
                {% endif %}
            </div>
            {% endfor %}

            <button type="submit" class="btn btn-primary btn-lg w-100 mt-3">
                <i class="bi bi-person-plus me-2"></i> Create Shop Owner Account
            </button>

            <div class="text-center mt-4">
                <p class="text-muted">Already have an account? <a href="{% url 'accounts:login' %}">Sign in</a></p>
                <p class="text-muted">Want to register as a customer instead? 
                    <a href="{% url 'accounts:register_customer' %}">Register as Customer</a>
                </p>
            </div>
        </form>
      </div>
    </div>
  </div>
</div>

<style>
/* ===== BASE STYLES ===== */
#registration-form-page .container,
#success-page .container {
    max-width: 600px;
    margin: 2rem auto;
    padding: 0 1rem;
}

.card {
    background: #ffffff;
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    padding: 2rem;
    margin-bottom: 2rem;
}

/* ===== TYPOGRAPHY ===== */
h2 {
    color: #2c3e50;
    margin-bottom: 1.8rem;
    font-weight: 600;
    font-size: 1.8rem;
    text-align: center;
}

.text-muted {
    color: #636e72 !important;
    font-size: 0.95rem;
}

/* ===== FORM CONTROLS ===== */
.form-control {
    width: 100%;
    padding: 0.9rem;
    font-size: 1rem;
    border: 1px solid #dfe6e9;
    border-radius: 8px;
    background-color: #fbfcfc;
    color: #2d3436;
    transition: all 0.25s ease;
    margin-bottom: 0.5rem;
}

.form-control:focus {
    border-color: #0984e3;
    outline: 0;
    box-shadow: 0 0 0 3px rgba(9, 132, 227, 0.15);
    background-color: #fff;
}

/* ===== INPUT GROUPS ===== */
.input-group {
    display: flex;
    margin-bottom: 1rem;
}

.input-group-text {
    padding: 0.9rem;
    background-color: #f5f6fa;
    border: 1px solid #dfe6e9;
    color: #636e72;
    font-weight: 500;
}

.input-group .form-control {
    margin-bottom: 0;
    border-radius: 0 8px 8px 0 !important;
}

.input-group .btn-outline-secondary {
    border-radius: 0 8px 8px 0;
    border-left: none;
    background-color: #f5f6fa;
    border-color: #dfe6e9;
    color: #636e72;
}

/* ===== BUTTONS ===== */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    font-size: 1rem;
    font-weight: 500;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.25s ease;
}

.btn-primary {
    background-color: #0984e3;
    border: 1px solid #0984e3;
    color: white;
}

.btn-primary:hover {
    background-color: #0767b3;
    border-color: #0767b3;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(9, 132, 227, 0.2);
}

/* ===== VALIDATION STATES ===== */
.invalid-feedback {
    color: #d63031;
    font-size: 0.85rem;
    margin-top: 0.25rem;
    display: block;
    font-weight: 500;
}

.is-invalid {
    border-color: #d63031 !important;
}

/* ===== ERROR CONTAINER ===== */
#error-container {
    position: sticky;
    top: 20px;
    z-index: 1000;
}

.alert-danger {
    background-color: #ffecec;
    border: 1px solid #ffc9c9;
    color: #d63031;
    padding: 1rem;
    border-radius: 8px;
    font-weight: 500;
}

/* ===== SUCCESS PAGE ===== */
#success-page {
    text-align: center;
}

#success-page img {
    margin-bottom: 1.5rem;
}

#success-page h2 {
    color: #2ecc71;
}

#success-page .lead {
    color: #2c3e50;
    font-size: 1.1rem;
    margin-bottom: 1.5rem;
}

/* ===== PASSWORD TOGGLE ===== */
.toggle-password {
    cursor: pointer;
    border-left: none !important;
}

.bi-eye-slash, .bi-eye {
    font-size: 1.1rem;
}

/* ===== RESPONSIVE ADJUSTMENTS ===== */
@media (max-width: 768px) {
    .card {
        padding: 1.5rem;
    }
    
    .mb-3.row.g-2 {
        flex-direction: column;
    }
    
    .col-md-6 {
        width: 100%;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Password toggle functionality
    document.querySelectorAll('.toggle-password').forEach(button => {
        button.addEventListener('click', function() {
            const input = this.closest('.input-group').querySelector('input');
            const icon = this.querySelector('i');
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.replace('bi-eye-slash', 'bi-eye');
            } else {
                input.type = 'password';
                icon.classList.replace('bi-eye', 'bi-eye-slash');
            }
        });
    });

    // Phone number validation
    const phoneInput = document.getElementById('id_phone');
    const phoneError = document.getElementById('phone-error');
    
    if (phoneInput) {
        phoneInput.addEventListener('input', function() {
            // Remove any non-digit characters
            this.value = this.value.replace(/\D/g, '');
            
            // Remove leading 0 if entered
            if (this.value.startsWith('0')) {
                this.value = this.value.substring(1);
            }
            
            // Validate length
            if (this.value.length > 9) {
                this.value = this.value.slice(0, 9);
            }
            
            // Show/hide error message
            if (this.value.length !== 9 && this.value.length > 0) {
                phoneError.textContent = 'Please enter exactly 9 digits (without the leading 0)';
                phoneError.style.display = 'block';
                this.classList.add('is-invalid');
            } else {
                phoneError.style.display = 'none';
                this.classList.remove('is-invalid');
            }
        });
    }

    // AJAX Form Submission
    $('#registration-form').on('submit', function(e) {
        e.preventDefault();

        $.ajax({
            type: 'POST',
            url: $(this).attr('action') || window.location.href,
            data: $(this).serialize(),
            success: function(response) {
                if (response.redirect_url) {
                    // Show success page
                    $('#registration-form-page').hide();
                    $('#success-page').show();
                    window.scrollTo(0, 0);

                    // Optional delay before redirect
                    setTimeout(() => {
                        window.location.href = response.redirect_url;
                    }, 5000);
                }
            },
            error: function(xhr) {
                let errorMsg = 'Something went wrong. Please try again.';
                const errorContainer = $('#error-container');
                const errorMessage = $('#error-message');

                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg = xhr.responseJSON.error;
                }

                errorMessage.text(errorMsg);
                errorContainer.slideDown();

                $('html, body').animate({
                    scrollTop: errorContainer.offset().top - 20
                }, 500);
            }
        });
    });
});
</script>
{% endblock %}